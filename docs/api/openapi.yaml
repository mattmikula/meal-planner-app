openapi: 3.1.0
info:
  title: Meal Planner API
  version: "0.1.0"
  description: |-
    API surface for the Meal Planner app. This spec documents current endpoints
    and leaves placeholders for planned routes.
servers:
  - url: http://localhost:3000
    description: Local development

tags:
  - name: Health
    description: Service health checks
  - name: Auth
    description: Authentication-related endpoints
  - name: Household
    description: Household sharing and invites
  - name: Audit
    description: Household audit trail

paths:
  /api/health:
    get:
      summary: Health check
      description: Confirms the API can reach the database.
      tags:
        - Health
      responses:
        "200":
          description: Database reachable.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthOk"
              examples:
                ok:
                  summary: Healthy response
                  value:
                    ok: true
        "500":
          description: Database error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthError"
              examples:
                dbError:
                  summary: Database error
                  value:
                    ok: false
                    error: Database error

  /api/me:
    get:
      summary: Get current user
      description: |-
        Returns the authenticated user. Accepts a Bearer token in the
        Authorization header, or refresh cookies set by the web auth flow.
      tags:
        - Auth
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Authenticated user.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
              examples:
                user:
                  summary: Authenticated user
                  value:
                    id: 3e0f3d65-2d7a-4f60-9d5c-6df2b6fbe5e8
                    email: ada@example.com
        "401":
          description: Missing or invalid credentials.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                unauthorized:
                  summary: Unauthorized
                  value:
                    error: Unauthorized

  /api/household:
    get:
      summary: Get household context
      description: Returns the current household and membership for the user. If no current household is set, the earliest active membership is used.
      tags:
        - Household
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Household context.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HouseholdContext"
              examples:
                household:
                  summary: Household context
                  value:
                    id: 5f0f3d65-2d7a-4f60-9d5c-6df2b6fbe5e8
                    name: Home
                    role: owner
                    status: active
        "401":
          description: Missing or invalid credentials.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Household lookup failed.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/household/members:
    get:
      summary: List household members
      description: Returns all members for the current household.
      tags:
        - Household
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Household members.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HouseholdMembersResponse"
              examples:
                members:
                  summary: Household members
                  value:
                    members:
                      - id: 3e0f3d65-2d7a-4f60-9d5c-6df2b6fbe5e8
                        userId: 2b0f3d65-2d7a-4f60-9d5c-6df2b6fbe5e8
                        role: owner
                        status: active
                        createdAt: "2024-02-12T10:00:00Z"
        "401":
          description: Missing or invalid credentials.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Member lookup failed.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/household/invites:
    post:
      summary: Create household invite
      description: Creates an invite and returns a shareable invite link.
      tags:
        - Household
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/HouseholdInviteRequest"
            examples:
              invite:
                summary: Invite request
                value:
                  email: ada@example.com
      responses:
        "200":
          description: Invite created.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HouseholdInviteResponse"
              examples:
                invite:
                  summary: Invite response
                  value:
                    inviteId: 6e0f3d65-2d7a-4f60-9d5c-6df2b6fbe5e8
                    inviteUrl: https://mealplanner.app/invite?invite_token=token-value
        "400":
          description: Invalid request body.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Missing or invalid credentials.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Invite creation failed.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/household/invites/accept:
    post:
      summary: Accept household invite
      description: Accepts an invite token and joins the household.
      tags:
        - Household
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/HouseholdInviteAcceptRequest"
            examples:
              accept:
                summary: Accept invite request
                value:
                  token: invite-token
      responses:
        "200":
          description: Invite accepted.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HouseholdInviteAcceptResponse"
              examples:
                accepted:
                  summary: Accept response
                  value:
                    householdId: 5f0f3d65-2d7a-4f60-9d5c-6df2b6fbe5e8
                    memberId: 6e0f3d65-2d7a-4f60-9d5c-6df2b6fbe5e8
        "400":
          description: Invalid or expired invite.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Missing or invalid credentials.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Invite email mismatch.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: Invite already used or member exists in this household.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Invite acceptance failed.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/audit:
    get:
      summary: List audit events
      description: Returns audit events for the household.
      tags:
        - Audit
      security:
        - bearerAuth: []
      parameters:
        - name: entity
          in: query
          description: Filter by entity type.
          required: false
          schema:
            type: string
            enum: [meal, plan, plan_day]
        - name: limit
          in: query
          description: Limit the number of events (max 100).
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
      responses:
        "200":
          description: Audit events.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuditResponse"
              examples:
                events:
                  summary: Audit events
                  value:
                    items:
                      - id: 7f0f3d65-2d7a-4f60-9d5c-6df2b6fbe5e8
                        entityType: meal
                        entityId: 8f0f3d65-2d7a-4f60-9d5c-6df2b6fbe5e8
                        action: meal.updated
                        actorUserId: 9f0f3d65-2d7a-4f60-9d5c-6df2b6fbe5e8
                        createdAt: "2024-02-12T10:00:00Z"
                        summary:
                          mealId: 8f0f3d65-2d7a-4f60-9d5c-6df2b6fbe5e8
                          name: Pasta
        "400":
          description: Invalid filters.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Missing or invalid credentials.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Audit lookup failed.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/meals:
    summary: Meals endpoints (placeholder)
    description: Placeholder for CRUD endpoints on meals.
    x-placeholder: true

  /api/verify-otp:
    post:
      summary: Verify email OTP
      description: Verify a one-time passcode and set auth cookies.
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VerifyOtpRequest"
            examples:
              verify:
                summary: Verify OTP request
                value:
                  email: ada@example.com
                  token: "123456"
      responses:
        "200":
          description: Verified user.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
              examples:
                user:
                  summary: Authenticated user
                  value:
                    id: 3e0f3d65-2d7a-4f60-9d5c-6df2b6fbe5e8
                    email: ada@example.com
        "400":
          description: Invalid request body.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                invalid:
                  summary: Missing fields
                  value:
                    error: Email and code are required.
        "401":
          description: Invalid or expired code.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                invalidCode:
                  summary: Invalid code
                  value:
                    error: Invalid or expired code.

  /api/logout:
    post:
      summary: Log out
      description: Clear authentication cookies.
      tags:
        - Auth
      responses:
        "200":
          description: Signed out.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LogoutOk"
              examples:
                ok:
                  summary: Signed out
                  value:
                    ok: true

  /api/meals/{id}:
    summary: Meal endpoints by id (placeholder)
    description: Placeholder for single-meal operations.
    x-placeholder: true

  /api/plans:
    summary: Plans endpoints (placeholder)
    description: Placeholder for plan fetch endpoints.
    x-placeholder: true

  /api/plans/generate:
    summary: Plan generation endpoints (placeholder)
    description: Placeholder for plan generation endpoints.
    x-placeholder: true

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    HealthOk:
      type: object
      required:
        - ok
      properties:
        ok:
          type: boolean
          const: true

    HealthError:
      type: object
      required:
        - ok
        - error
      properties:
        ok:
          type: boolean
          const: false
        error:
          type: string

    User:
      type: object
      required:
        - id
        - email
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email

    VerifyOtpRequest:
      type: object
      required:
        - email
        - token
      properties:
        email:
          type: string
          format: email
        token:
          type: string

    LogoutOk:
      type: object
      required:
        - ok
      properties:
        ok:
          type: boolean
          const: true

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string

    HouseholdContext:
      type: object
      required:
        - id
        - name
        - role
        - status
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          nullable: true
        role:
          type: string
          enum: [owner, member]
        status:
          type: string
          enum: [active, inactive]

    HouseholdMember:
      type: object
      required:
        - id
        - userId
        - role
        - status
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        role:
          type: string
          enum: [owner, member]
        status:
          type: string
          enum: [active, inactive]
        createdAt:
          type: string
          format: date-time

    HouseholdMembersResponse:
      type: object
      required:
        - members
      properties:
        members:
          type: array
          items:
            $ref: "#/components/schemas/HouseholdMember"

    HouseholdInviteRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email

    HouseholdInviteResponse:
      type: object
      required:
        - inviteId
        - inviteUrl
      properties:
        inviteId:
          type: string
          format: uuid
        inviteUrl:
          type: string
          format: uri

    HouseholdInviteAcceptRequest:
      type: object
      required:
        - token
      properties:
        token:
          type: string

    HouseholdInviteAcceptResponse:
      type: object
      required:
        - householdId
        - memberId
      properties:
        householdId:
          type: string
          format: uuid
        memberId:
          type: string
          format: uuid

    AuditEvent:
      type: object
      required:
        - id
        - entityType
        - entityId
        - action
        - actorUserId
        - createdAt
        - summary
      properties:
        id:
          type: string
          format: uuid
        entityType:
          type: string
          enum: [meal, plan, plan_day]
        entityId:
          type: string
          format: uuid
        action:
          type: string
        actorUserId:
          type: string
          format: uuid
          nullable: true
        createdAt:
          type: string
          format: date-time
        summary:
          type: object

    AuditResponse:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/AuditEvent"
